var width=window.innerWidth,height=window.innerHeight,left_section_object=[],mid_section_object=[],right_section_object=[],stage=new Konva.Stage({container:"canvas",width:width,height:height,fill:"gray"}),layer=new Konva.Layer({x:0,y:0}),layer_front=new Konva.Layer({x:0,y:0}),front_text=new Konva.Text({x:5,y:10,fontSize:20,fontFamily:"Calibri",fill:"grey",text:"Outside View(Doors View)"}),inner_text=new Konva.Text({x:5,y:10,fontSize:20,fontFamily:"Calibri",fill:"grey",text:"Inside View of Closet"});layer_front.add(front_text),layer.add(inner_text),stage.add(layer),stage.add(layer_front),layer_front.draw(),show_front_side();var na_left=1e4,na_mid=1e4,na_right=1e4;function Image_draw(e,t,a,r,o,i,n){var d=stage.find(n)[0],s=new Konva.Image({image:e,x:t,y:a,width:r,height:o,draggable:!0,id:i,offsetX:0,offsetY:0});s.on("mouseover",function(){document.body.style.cursor="pointer",layer.draw()}),s.on("mouseout",function(){document.body.style.cursor="default"}),s.on("dragend",function(){console.log("dropping start");var e=this.attrs.x,t=this.attrs.y,a=d,r=a.attrs.x,o=a.attrs.y,i=a.attrs.width,n=a.attrs.height;console.log("drop item x:",e),console.log("target item x:",r),console.log("drop item y:",t),console.log("target item y:",o),e>r&&e<i+r&&t>o&&t<n+o&&(console.log("dropping"),this.position({x:r+(i/2-this.attrs.width/2),y:o+(n/2-this.attrs.height/2)}),layer.draw())}),layer.add(s),stage.add(layer),layer.draw()}function closet_dimension(){var e=4*document.getElementById("width_input").value,t=4*document.getElementById("height_input").value;if(void 0==stage.find("#closet")[0]){console.log("generating first time closet structure");var a=new Konva.Rect({x:0,y:30,width:e+8,height:t+4,fill:"#ffffee",stroke:"gray",strokeWidth:1,id:"closet"}),r=new Konva.Rect({x:2,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_left"});left_section_object[0]={attrs:{x:4,y:32,height:0,width:e/3-4}};var o=new Konva.Rect({x:e/3+4,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_mid"});mid_section_object[0]={attrs:{x:e/3+6,y:32,height:0,width:e/3-4}};var i=new Konva.Rect({x:e/3*2+6,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_right"});right_section_object[0]={attrs:{x:e/3*2+8,y:32,height:0,width:e/3-4}},layer.add(a),layer.add(r),layer.add(o),layer.add(i),layer_front.add(a.clone({id:"closet_clone"})),layer_front.add(r.clone({id:"section_left_clone"})),layer_front.add(o.clone({id:"section_mid_clone"})),layer_front.add(i.clone({id:"section_right_clone"})),door_change("left"),door_change("mid"),door_change("right"),layer.draw(),layer_front.draw(),console.log(stage.find("#closet_clone")[0])}else{var n=stage.find("#closet")[0],d=stage.find("#section_left")[0],s=stage.find("#section_mid")[0],l=stage.find("#section_right")[0];console.log(n),n.destroy(),d.destroy(),s.destroy(),l.destroy(),n=stage.find("#closet_clone")[0],d=stage.find("#section_left_clone")[0],s=stage.find("#section_mid_clone")[0],l=stage.find("#section_right_clone")[0],n.destroy(),d.destroy(),s.destroy(),l.destroy(),layer.draw(),layer_front.draw(),console.log("regenerating closet structure");a=new Konva.Rect({x:0,y:30,width:e+8,height:t+4,fill:"#ffffee",stroke:"gray",strokeWidth:1,id:"closet"}),r=new Konva.Rect({x:2,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_left"});left_section_object[0]={attrs:{x:4,y:32,height:0,width:e/3-4}},o=new Konva.Rect({x:e/3+4,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_mid"}),mid_section_object[0]={attrs:{x:e/3+6,y:32,height:0,width:e/3-4}};i=new Konva.Rect({x:e/3*2+6,y:a.attrs.y+2,width:e/3,height:t,fill:"#eeeedd",stroke:"grey",strokeWidth:1,id:"section_right"});right_section_object[0]={attrs:{x:e/3*2+8,y:32,height:0,width:e/3-4}},layer.add(a),layer.add(r),layer.add(o),layer.add(i),layer_front.add(a.clone({id:"closet_clone"})),layer_front.add(r.clone({id:"section_left_clone"})),layer_front.add(o.clone({id:"section_mid_clone"})),layer_front.add(i.clone({id:"section_right_clone"})),door_change("left"),door_change("mid"),door_change("right"),layer.draw(),layer_front.draw(),console.log(left_section_object)}stage.add(layer),layer.draw(),document.getElementById("proceed_1").style.display="block",console.log("left section",left_section_object),console.log("mid section",mid_section_object),console.log("right section",right_section_object)}function drawer_left_change(e){if("true"===e.value){var t=stage.find("#section_left")[0],a=stage.find("#hanger_left")[0];if(void 0==a){var r=new Konva.Rect({id:"drawer_left",offsetX:0,offsetY:0,x:t.attrs.x+2,y:t.attrs.y+2,fill:"#dddddd",stroke:"grey",strokeWidth:1,width:t.attrs.width-4,height:30});layer.add(r).draw()}else{var r=new Konva.Rect({id:"drawer_left",offsetX:0,offsetY:0,x:t.attrs.x+2,y:a.attrs.height+6,fill:"#dddddd",stroke:"grey",strokeWidth:1,width:t.attrs.width-4,height:30});layer.add(r).draw()}(r=new Image).onload=function(){var e=stage.find("#drawer_left")[0];console.log("drawer:",e),Image_draw(this,600,200,e.attrs.width,e.attrs.height,"drawer_left_img","#drawer_left")},r.src="images/drawer_front_1.jpg";var o=new Image;o.onload=function(){Image_draw(this,500,200,30,10,"handle_img","#drawer_left_img")},o.src="images/handle.png",layer.draw()}else stage.find("#drawer_left")[0].destroy(),stage.find("#drawer_left_img")[0].destroy(),stage.find("#handle_img")[0].destroy(),layer.draw()}function hanger_change(e){console.log("hanger");var t,a=document.getElementById("hanger_"+e).value;switch(e){case"left":t=left_section_object;break;case"mid":t=mid_section_object;break;case"right":t=right_section_object}if("true"===a)if(console.log(t),1==t.length){a=new Konva.Rect({id:"hanger_"+e,offsetX:0,offsetY:0,x:t[0].attrs.x,y:t[0].attrs.y+2,fill:"#dddddd",stroke:"grey",strokeWidth:1,width:t[0].attrs.width,height:80});t.push(a),a.on("mousedown",function(){alert(a.attrs.id)}),a.on("mouseover",function(){}),layer.add(a),layer.draw()}else document.getElementById("hanger_"+e).selectedIndex=0,document.getElementById("hanger_height_"+e).value="20",console.log("there is hurdle");else{document.getElementById("hanger_"+e).selectedIndex=0,document.getElementById("hanger_height_"+e).value="20",t.splice(t.findIndex(function(e){e.attrs.id}),1);a=stage.find("#hanger_"+e)[0];console.log("destroying hanger left",a),a.destroy(),layer.draw()}}function hanger_height_change(e,t){var a,r,o=4*e.value,i=stage.find("#section_"+t)[0],n=stage.find("#hanger_"+t)[0];switch(t){case"left":a=left_section_object,r=na_left;break;case"mid":a=mid_section_object,r=na_mid;break;case"right":a=right_section_object,r=na_right}console.log("obj",a);for(var d=!1,s=1;s<a.length;s++)a[s].attrs.y<=o+n.attrs.y&&a[s].attrs.id!="hanger_"+t&&(console.log("hurdle in a way:",a[s].attrs.id),d=!0);if(console.log("hanger y:",n.attrs.y),console.log("value height:",o),console.log("na value:",r),!(o<i.attrs.height&&!d&&n.attrs.y+o<r))return!1;n.attrs.height=o,layer.draw()}function drawer_add(e){var t,a;switch(e){case"left":t=left_section_object,a=na_left;break;case"mid":t=mid_section_object,a=na_mid;break;case"right":t=right_section_object,a=na_right}var r=t[t.length-1].attrs.x,o=t[t.length-1].attrs.width,i=t[t.length-1].attrs.y+t[t.length-1].attrs.height,n=stage.find("#section_"+e)[0].attrs.height+stage.find("#section_"+e)[0].attrs.y;if(console.log("creating a drawer"),console.log("upper y:",i),console.log("lower y:",n),console.log("lower y-2:",a-2),n-i-2>20&&a-i-2>20){var d=new Konva.Rect({id:"drawer_"+e+"_"+Math.floor(5e3*Math.random()+5e3*Math.random()),offsetX:0,offsetY:0,x:r,y:i+2,fill:"#dddddd",stroke:"grey",strokeWidth:1,width:o,height:20,name:"drawer "+e});d.on("dblclick",function(){t.splice(t.findIndex(function(e){e.attrs.id,d.attrs.id}),1),d.destroy(),layer.draw(),console.log("after",t)}),layer.add(d).draw(),t.push(d)}else alert("not enough space left")}function shelf_add(e){var t,a;switch(e){case"left":t=left_section_object,a=na_left;break;case"mid":t=mid_section_object,a=na_mid;break;case"right":t=right_section_object,a=na_right}var r=t[t.length-1].attrs.x,o=t[t.length-1].attrs.width,i=t[t.length-1].attrs.y+t[t.length-1].attrs.height,n=stage.find("#section_"+e)[0].attrs.height+stage.find("#section_"+e)[0].attrs.y;if(console.log("creating a shelf"),console.log("upper y:",i),console.log("lower y:",n),n-i-40>4&&a-i-2>44){var d=new Konva.Rect({id:"shelf_"+e+"_"+Math.floor(5e3*Math.random()+5e3*Math.random()),offsetX:0,offsetY:0,x:r,y:i+40,fill:"#dddddd",stroke:"grey",strokeWidth:1,width:o,height:4});d.on("click",function(){console.log("before",left_section_object)}),d.on("dblclick",function(){t.splice(t.findIndex(function(e){e.attrs.id,d.attrs.id}),1),d.destroy(),layer.draw(),console.log("after",t)}),layer.add(d).draw(),t.push(d)}else alert("not enough space left")}function door_change(e){var t=document.getElementById("door_"+e+"_select").value,a=stage.find("#section_"+e)[0],r=stage.find("#section_"+e+"_clone")[0];stage.find("#door_"+e)[0]&&((o=stage.find("#door_"+e)[0]).destroy(),stage.find("#drawer_outside_1_"+e)[0]&&(stage.find("#drawer_outside_1_"+e)[0].destroy(),stage.find("#drawer_outside_2_"+e)[0]&&stage.find("#drawer_outside_2_"+e)[0].destroy()),stage.find("#na_"+e+"_img")[0]&&stage.find("#na_"+e+"_img")[0].destroy(),layer.draw(),layer_front.draw());if("full"===t){var o=new Konva.Rect({id:"door_"+e,x:r.attrs.x,y:r.attrs.y,width:r.attrs.width,height:r.attrs.height,stroke:"green",strokeWidth:1});switch(e){case"left":na_left=1e4;break;case"mid":na_mid=1e4;break;case"right":na_right=1e4}layer_front.add(o),layer_front.draw()}else if("half-1"===t){o=new Konva.Rect({id:"door_"+e,x:r.attrs.x,y:r.attrs.y,width:r.attrs.width,height:.8*r.attrs.height,stroke:"green",strokeWidth:1});switch(e){case"left":na_left=o.attrs.y+o.attrs.height;break;case"mid":na_mid=o.attrs.y+o.attrs.height;break;case"right":na_right=o.attrs.y+o.attrs.height}var i=new Konva.Rect({id:"drawer_outside_1_"+e,x:r.attrs.x,y:2+r.attrs.y+.8*r.attrs.height,width:r.attrs.width,height:.2*r.attrs.height-2,stroke:"purple",strokeWidth:1});if(layer_front.add(i),layer_front.add(o),layer_front.draw(),stage.find("#na_"+e+"_img")[0])(n=stage.find("#na_"+e+"_img")[0]).position({x:a.attrs.x,y:a.attrs.y+.8*a.attrs.height}),n.attrs.height=.2*a.attrs.height,layer.draw();else(n=new Image).onload=function(){Image_draw(n,a.attrs.x,a.attrs.y+.8*a.attrs.height,a.attrs.width,.2*a.attrs.height,"na_"+e+"_img","Eee")},n.src="images/grey_stripes.png",layer.draw()}else if("half-2"===t){o=new Konva.Rect({id:"door_"+e,x:r.attrs.x,y:r.attrs.y,width:r.attrs.width,height:.6*r.attrs.height,stroke:"green",strokeWidth:1}),i=new Konva.Rect({id:"drawer_outside_1_"+e,x:a.attrs.x,y:2+a.attrs.y+.6*a.attrs.height,width:a.attrs.width,height:.2*a.attrs.height-2,stroke:"purple",strokeWidth:1});var n,d=new Konva.Rect({id:"drawer_outside_2_"+e,x:a.attrs.x,y:2+a.attrs.y+.8*a.attrs.height,width:a.attrs.width,height:.2*a.attrs.height-2,stroke:"purple",strokeWidth:1});switch(e){case"left":na_left=o.attrs.y+o.attrs.height;break;case"mid":na_mid=o.attrs.y+o.attrs.height;break;case"right":na_right=o.attrs.y+o.attrs.height}if(layer_front.add(i),layer_front.add(d),layer_front.add(o),layer_front.draw(),stage.find("#na_"+e+"_img")[0])(n=stage.find("#na_"+e+"_img")[0]).position({x:a.attrs.x,y:a.attrs.y+.6*a.attrs.height}),n.attrs.height=.4*a.attrs.height,layer.draw();else(n=new Image).onload=function(){Image_draw(n,a.attrs.x,a.attrs.y+.6*a.attrs.height,a.attrs.width,.4*a.attrs.height,"na_"+e+"_img","Eee")},n.src="images/grey_stripes.png"}console.log("not available left",na_left),console.log("not available mid",na_mid),console.log("not available right",na_right)}function show_front_side(){layer.hide(),layer_front.show(),layer_front.draw()}function show_inner_side(){layer_front.hide(),layer.show(),layer.draw()}function proceed_1(){document.getElementById("closet_dimension_select").style.display="none",document.getElementById("doors_option_select").style.display="block",document.getElementById("select_side").style.display="block"}function proceed_2(){document.getElementById("inside_view_options").style.display="block",document.getElementById("doors_option_select").style.display="none"}function proceed_3(){var e=stage.toJSON();console.log(e)}